sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/json/JSONModel"],function(e,t,o,i,s){"use strict";return e.extend("custombookshop.controller.Main",{onInit:function(){var e=new s({authorNameVisibility:false,categoryNameVisibility:false});this.getOwnerComponent().setModel(e,"viewModel");this.viewModel=this.getOwnerComponent().getModel("viewModel");this.i18n=this.getOwnerComponent().getModel("i18n").getResourceBundle()},onAfterRendering:function(){this.getView().getModel().read("/Authors",{success:$.proxy(function(e){this.viewModel.setProperty("/authors",e.results)},this)});this.getView().getModel().read("/Categories",{success:$.proxy(function(e){this.viewModel.setProperty("/categories",e.results)},this)})},onScanSuccess:function(e){var t=e.getParameter("text");var o=this.byId("smartFilterBar");o.setFilterData({isbn:t});o.getControlByKey("isbn").setValue(t);o.search()},onCreateBook:function(e){if(this._oDialog){this._oDialog.destroy();this._oDialog=undefined}this.openDialog(e)},onPressIsbn:function(e){let t=e.getSource().getBindingContext().getObject();let o="https://isbndb.com/book/"+t.isbn;window.open(o,"_blank")},onEditBook:function(e){this.openDialog(e,e.getSource().getBindingContext().getPath())},onDeleteBook:function(e){var t=e.getSource().getBindingContext();this.sPathToDelete=this.getView().getModel().createKey("/Books",{ID:t.getProperty("ID")});if(!this._oBookDeleteDialog){this._oBookDeleteDialog=new sap.m.Dialog({type:sap.m.DialogType.Message,title:this.i18n.getText("confirm"),content:new sap.m.Text({text:this.i18n.getText("areUSureBookDelete")}),beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:this.i18n.getText("delete"),press:function(){this.getView().getModel().remove(this.sPathToDelete,{success:$.proxy(function(e,t){o.show(this.i18n.getText("succBookDelete"))},this)});this._oBookDeleteDialog.close()}.bind(this)}),endButton:new sap.m.Button({text:this.i18n.getText("cancel"),press:function(){this._oBookDeleteDialog.close()}.bind(this)})});this._oBookDeleteDialog.open()}else{this._oBookDeleteDialog.open()}},onCreateAuthor:function(){this.viewModel.setProperty("/authorNameVisibility",true)},onCreateCategory:function(){this.viewModel.setProperty("/categoryNameVisibility",true)},openDialog:function(e,o){this.getView().getModel().resetChanges();this.viewModel.setProperty("/authorName","");if(!this.CreateBookDialog){t.load({id:"CreateBookDialog",name:"custombookshop.view.fragments.CreateBook",controller:this}).then(function(e){this.CreateBookDialog=e;this.getView().addDependent(this.CreateBookDialog);if(o!==undefined){this.bIsCreateNew=false;this.bindExistingBook(o)}else{this.bIsCreateNew=true;this.bindNewBook()}this.setDialogTitle(o);this.CreateBookDialog.open()}.bind(this))}else{if(o!==undefined){this.bIsCreateNew=false;this.bindExistingBook(o)}else{this.bIsCreateNew=true;this.bindNewBook()}this.setDialogTitle(o);this.CreateBookDialog.open()}},bindExistingBook:function(e){this.CreateBookDialog.bindElement({path:e});this.viewModel.setProperty("/authorNameVisibility",false);this.viewModel.setProperty("/categoryNameVisibility",false)},bindNewBook:function(){this.viewModel.setProperty("/authorNameVisibility",false);this.viewModel.setProperty("/categoryNameVisibility",false);this.tempEvent=this.getView().getModel().createEntry("Books",{properties:{}});this.CreateBookDialog.bindElement({path:this.tempEvent.getPath()})},setDialogTitle:function(e){if(this.CreateBookDialog){if(e!==undefined){this.CreateBookDialog.setTitle(this.i18n.getText("changeBook"))}else{this.CreateBookDialog.setTitle(this.i18n.getText("maintainBook"))}}},onCloseCreateBookDialog:function(){this.CreateBookDialog.close();this.tempEvent=null;this.CreateBookDialog.unbindElement()},saveBook:function(){let e=this.getView().getModel();let t=this.viewModel.getProperty("/authorName");if(t){this.authorEvent=this.getView().getModel().createEntry("/Authors",{properties:{name:t,ID:this.viewModel.getProperty("/authors").length+1}});e.setProperty(this.tempEvent.getPath()+"/author_ID",this.authorEvent.getProperty("ID"))}let s=this.viewModel.getProperty("/categoryName");if(s){this.categoryEvent=this.getView().getModel().createEntry("/Categories",{properties:{name:s,ID:this.viewModel.getProperty("/categories").length+1}});e.setProperty(this.tempEvent.getPath()+"/category_ID",this.categoryEvent.getProperty("ID"))}if(this.bIsCreateNew){this.setI18nResponseMsg("successfullyCreated","")}else{this.setI18nResponseMsg("successfullyUpdated","")}e.submitChanges({success:$.proxy(function(){o.show(this.i18n.getText(this.successI18nMsg))},this),error:function(e){var t=JSON.parse(e.responseText).error.message.value;i.error(t)}});this.CreateBookDialog.close()},setI18nResponseMsg:function(e,t){this.successI18nMsg=e},onBorrowBook:function(){if(!this.BorrowBookDialog){t.load({id:"BorrowBookDialog",name:"custombookshop.view.fragments.BorrowBook",controller:this}).then(function(e){this.BorrowBookDialog=e;this.getView().addDependent(this.BorrowBookDialog);this.bindNewBorrowBook();this.BorrowBookDialog.open()}.bind(this))}else{this.bindNewBorrowBook();this.BorrowBookDialog.open()}},bindNewBorrowBook:function(){this.getView().getModel().resetChanges();this.borrowBookEvent=this.getView().getModel().createEntry("Reportings",{properties:{borrowedDate:new Date,bookName:""}});this.BorrowBookDialog.bindElement({path:this.borrowBookEvent.getPath()})},onScanBorrowBookSuccess:function(e){if(e.getParameter("cancelled")){o.show("Scan cancelled",{duration:1e3})}else{if(e.getParameter("text")){this.getView().getModel().setProperty(this.borrowBookEvent.getPath()+"/book_ID",e.getParameter("text"))}else{o.show("")}}},onScanBorrowBookError:function(e){o.show("Scan failed: "+e,{duration:1e3})},saveBorrowBook:function(){let e=this.getView().getModel();let t=this.borrowBookEvent.getProperty("book_ID");let s=e.getProperty("/Books("+t+")");this.getView().getModel().setProperty(this.borrowBookEvent.getPath()+"/bookName",s.title);if(s.availability==="N"){i.warning(this.i18n.getText("borrowedBookWarning"));return 1}e.submitChanges({success:$.proxy(function(){o.show(this.i18n.getText("successfullyCreated"));this.getView().byId("idTblBookData").rebindTable();this.onCloseBorrowBookDialog();this.byId("smartChartBooks").rebindChart();this.byId("smartChartAuthors").rebindChart()},this),error:function(e){var t=JSON.parse(e.responseText).error.message.value;i.error(t)}})},onCloseBorrowBookDialog:function(){this.BorrowBookDialog.close();this.borrowBookEvent=null;this.BorrowBookDialog.unbindElement()}})});